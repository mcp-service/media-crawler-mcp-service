{% extends "layout.html" %}

{% block title %}配置管理 - MCP Tools{% endblock %}

{% block content %}
<div class="space-y-6" x-data="configManager()">
    <!-- 平台配置 -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold mb-4">⚙️ 平台配置</h2>
        <div class="space-y-4" x-cloak>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">启用的平台</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <template x-for="platform in allPlatforms" :key="platform">
                        <label class="flex items-center space-x-2 p-2 border rounded hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox"
                                   :value="platform"
                                   x-model="enabledPlatforms"
                                   class="rounded">
                            <span class="text-sm" x-text="platformNames[platform]"></span>
                        </label>
                    </template>
                </div>
            </div>
            <button @click="savePlatformConfig"
                    class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-6 rounded">
                保存平台配置
            </button>
        </div>
    </div>

    <!-- 爬虫配置 -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold mb-4">🕷️ 爬虫配置</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" x-cloak>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">最大爬取数量</label>
                <input type="number" x-model.number="crawlerConfig.max_notes"
                       class="w-full border rounded p-2" min="1" max="1000">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">每帖最大评论数</label>
                <input type="number" x-model.number="crawlerConfig.max_comments_per_note"
                       class="w-full border rounded p-2" min="0" max="100">
            </div>
            <div>
                <label class="flex items-center space-x-2 p-2 border rounded">
                    <input type="checkbox" x-model="crawlerConfig.enable_comments" class="rounded">
                    <span>启用评论爬取</span>
                </label>
            </div>
            <div>
                <label class="flex items-center space-x-2 p-2 border rounded">
                    <input type="checkbox" x-model="crawlerConfig.headless" class="rounded">
                    <span>无头模式（无浏览器界面）</span>
                </label>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">数据保存方式</label>
                <select x-model="crawlerConfig.save_data_option" class="w-full border rounded p-2">
                    <option value="json">JSON文件</option>
                    <option value="csv">CSV文件</option>
                    <option value="sqlite">SQLite数据库</option>
                    <option value="db">MySQL/PostgreSQL数据库</option>
                </select>
            </div>
        </div>
        <button @click="saveCrawlerConfig"
                class="mt-4 bg-green-500 hover:bg-green-600 text-white py-2 px-6 rounded">
            保存爬虫配置
        </button>
    </div>

    <!-- 警告提示 -->
    <div x-show="needRestart" x-cloak
         class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
        <div class="flex">
            <div class="flex-shrink-0">⚠️</div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700">
                    配置已更新，需要重启服务使配置生效
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function configManager() {
    return {
        allPlatforms: [],
        platformNames: {},
        enabledPlatforms: [],
        crawlerConfig: {},
        needRestart: false,

        async init() {
            await this.loadPlatformConfig();
            await this.loadCrawlerConfig();
        },

        async loadPlatformConfig() {
            try {
                const response = await fetch('/api/config/platforms');
                const data = await response.json();
                this.allPlatforms = data.all_platforms;
                this.platformNames = data.platform_names;
                this.enabledPlatforms = data.enabled_platforms;
            } catch (error) {
                console.error('加载平台配置失败:', error);
            }
        },

        async loadCrawlerConfig() {
            try {
                const response = await fetch('/api/config/crawler');
                this.crawlerConfig = await response.json();
            } catch (error) {
                console.error('加载爬虫配置失败:', error);
            }
        },

        async savePlatformConfig() {
            try {
                const response = await fetch('/api/config/platforms', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        enabled_platforms: this.enabledPlatforms
                    })
                });
                const result = await response.json();
                this.needRestart = result.need_restart;
                alert(result.message);
            } catch (error) {
                alert('保存失败: ' + error.message);
            }
        },

        async saveCrawlerConfig() {
            try {
                const response = await fetch('/api/config/crawler', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(this.crawlerConfig)
                });
                const result = await response.json();
                this.needRestart = result.need_restart;
                alert(result.message);
            } catch (error) {
                alert('保存失败: ' + error.message);
            }
        }
    }
}
</script>
{% endblock %}
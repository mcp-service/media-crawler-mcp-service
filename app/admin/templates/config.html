{% extends "layout.html" %}

{% block title %}é…ç½®ç®¡ç† - MCP Tools{% endblock %}

{% block content %}
<!-- å¹³å°é…ç½® -->
<div class="card">
    <div class="card-header">
        <h2>âš™ï¸ å¹³å°é…ç½®</h2>
    </div>
    <div class="card-body">
        <form id="platform-config-form">
            <div class="form-group">
                <label class="form-label">å¯ç”¨çš„å¹³å°</label>
                <div class="platform-list" id="platform-checkboxes">
                    <!-- å¹³å°é€‰æ‹©å°†ç”±JavaScriptç”Ÿæˆ -->
                </div>
            </div>
            <button type="submit" class="btn btn-primary">ä¿å­˜å¹³å°é…ç½®</button>
        </form>
    </div>
</div>

<!-- çˆ¬è™«é…ç½® -->
<div class="card">
    <div class="card-header">
        <h2>ğŸ•·ï¸ çˆ¬è™«é…ç½®</h2>
    </div>
    <div class="card-body">
        <form id="crawler-config-form">
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="max_notes" class="form-label">æœ€å¤§çˆ¬å–æ•°é‡</label>
                        <input type="number" id="max_notes" name="max_notes" class="form-control" min="1" max="1000" value="15">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="max_comments_per_note" class="form-label">æ¯å¸–æœ€å¤§è¯„è®ºæ•°</label>
                        <input type="number" id="max_comments_per_note" name="max_comments_per_note" class="form-control" min="0" max="100" value="10">
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enable_comments" name="enable_comments" checked>
                            å¯ç”¨è¯„è®ºçˆ¬å–
                        </label>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="headless" name="headless">
                            æ— å¤´æ¨¡å¼ï¼ˆæ— æµè§ˆå™¨ç•Œé¢ï¼‰
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="save_data_option" class="form-label">æ•°æ®ä¿å­˜æ–¹å¼</label>
                <select id="save_data_option" name="save_data_option" class="form-control">
                    <option value="json">JSONæ–‡ä»¶</option>
                    <option value="csv">CSVæ–‡ä»¶</option>
                    <option value="sqlite">SQLiteæ•°æ®åº“</option>
                    <option value="db">MySQL/PostgreSQLæ•°æ®åº“</option>
                </select>
            </div>

            <div class="form-group">
                <label for="default_login_type" class="form-label">é»˜è®¤ç™»å½•æ–¹å¼</label>
                <select id="default_login_type" name="default_login_type" class="form-control">
                    <option value="qrcode">äºŒç»´ç æ‰«ç </option>
                    <option value="cookie">Cookieç™»å½•</option>
                    <option value="phone">æ‰‹æœºå·ç™»å½•</option>
                </select>
            </div>

            <button type="submit" class="btn btn-success">ä¿å­˜çˆ¬è™«é…ç½®</button>
        </form>
    </div>
</div>

<!-- è¾¹è½¦æœåŠ¡é…ç½® -->
<div class="card">
    <div class="card-header">
        <h2>ğŸš— è¾¹è½¦æœåŠ¡é…ç½®</h2>
    </div>
    <div class="card-body">
        <form id="sidecar-config-form">
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="sidecar_url" class="form-label">è¾¹è½¦æœåŠ¡åœ°å€</label>
                        <input type="url" id="sidecar_url" name="sidecar_url" class="form-control" 
                               value="http://localhost:8001" placeholder="http://localhost:8001">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="browser_pool_size" class="form-label">æµè§ˆå™¨æ± å¤§å°</label>
                        <input type="number" id="browser_pool_size" name="browser_pool_size" 
                               class="form-control" min="1" max="10" value="3">
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="sidecar_timeout" class="form-label">è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                        <input type="number" id="sidecar_timeout" name="sidecar_timeout" 
                               class="form-control" min="30" max="600" value="300">
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="session_timeout" class="form-label">ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</label>
                        <input type="number" id="session_timeout" name="session_timeout" 
                               class="form-control" min="600" max="86400" value="3600">
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-warning">ä¿å­˜è¾¹è½¦é…ç½®</button>
        </form>
    </div>
</div>

<!-- å½“å‰é…ç½®æ˜¾ç¤º -->
<div class="card">
    <div class="card-header">
        <h2>ğŸ“‹ å½“å‰é…ç½®</h2>
    </div>
    <div class="card-body">
        <button class="btn btn-info mb-3" onclick="loadCurrentConfig()">åˆ·æ–°é…ç½®</button>
        <div id="config-display" style="background: #f8f9fa; padding: 1rem; border-radius: 4px; font-family: monospace; white-space: pre-wrap;">
            ç‚¹å‡»"åˆ·æ–°é…ç½®"æŸ¥çœ‹å½“å‰é…ç½®
        </div>
    </div>
</div>

<!-- é‡å¯æé†’ -->
<div id="restart-warning" class="d-none" style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
    <div class="card" style="background: #fff3cd; border: 1px solid #ffeaa7;">
        <div class="card-body">
            <div style="display: flex; align-items: center;">
                <span style="font-size: 1.5rem; margin-right: 0.5rem;">âš ï¸</span>
                <div>
                    <strong>éœ€è¦é‡å¯æœåŠ¡</strong>
                    <p style="margin: 0; font-size: 0.875rem;">é…ç½®å·²æ›´æ–°ï¼Œéœ€è¦é‡å¯æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ</p>
                </div>
                <button onclick="hideRestartWarning()" style="margin-left: 1rem; background: none; border: none; font-size: 1.25rem;">Ã—</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let configData = {};

// åŠ è½½å¹³å°é€‰æ‹©
async function loadPlatformConfig() {
    try {
        const response = await apiRequest('/config/platforms');
        const platformContainer = document.getElementById('platform-checkboxes');
        
        const platforms = response.all_platforms || [];
        const enabledPlatforms = response.enabled_platforms || [];
        const platformNames = response.platform_names || {};
        
        platformContainer.innerHTML = platforms.map(platform => `
            <label style="display: flex; align-items: center; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin: 0.25rem; cursor: pointer;">
                <input type="checkbox" name="platforms" value="${platform}" ${enabledPlatforms.includes(platform) ? 'checked' : ''} style="margin-right: 0.5rem;">
                <span>${platformNames[platform] || platform}</span>
            </label>
        `).join('');
        
    } catch (error) {
        showError('åŠ è½½å¹³å°é…ç½®å¤±è´¥: ' + error.message);
    }
}

// åŠ è½½å½“å‰é…ç½®
async function loadCurrentConfig() {
    try {
        showMessage('æ­£åœ¨åŠ è½½é…ç½®...', 'info');
        
        const [crawlerConfig, sidecarConfig, platformConfig] = await Promise.all([
            apiRequest('/config/crawler'),
            apiRequest('/config/sidecar'),
            apiRequest('/config/platforms')
        ]);
        
        configData = {
            crawler: crawlerConfig,
            sidecar: sidecarConfig,
            platform: platformConfig
        };
        
        // å¡«å……è¡¨å•
        fillCrawlerForm(crawlerConfig);
        fillSidecarForm(sidecarConfig);
        
        // æ˜¾ç¤ºå®Œæ•´é…ç½®
        document.getElementById('config-display').textContent = JSON.stringify(configData, null, 2);
        
        showSuccess('é…ç½®å·²åŠ è½½');
    } catch (error) {
        showError('åŠ è½½é…ç½®å¤±è´¥: ' + error.message);
    }
}

function fillCrawlerForm(config) {
    document.getElementById('max_notes').value = config.max_notes || 15;
    document.getElementById('max_comments_per_note').value = config.max_comments_per_note || 10;
    document.getElementById('enable_comments').checked = config.enable_comments !== false;
    document.getElementById('headless').checked = config.headless || false;
    document.getElementById('save_data_option').value = config.save_data_option || 'json';
    document.getElementById('default_login_type').value = config.default_login_type || 'qrcode';
}

function fillSidecarForm(config) {
    document.getElementById('sidecar_url').value = config.url || 'http://localhost:8001';
    document.getElementById('browser_pool_size').value = config.browser_pool_size || 3;
    document.getElementById('sidecar_timeout').value = config.timeout || 300;
    document.getElementById('session_timeout').value = config.session_timeout || 3600;
}

// ä¿å­˜é…ç½®
async function savePlatformConfig(formData) {
    try {
        const platforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked'))
                               .map(cb => cb.value);
        
        const response = await apiRequest('/config/platforms', {
            method: 'PUT',
            body: JSON.stringify({ enabled_platforms: platforms })
        });
        
        showSuccess('å¹³å°é…ç½®ä¿å­˜æˆåŠŸ');
        if (response.need_restart) showRestartWarning();
        
    } catch (error) {
        showError('ä¿å­˜å¹³å°é…ç½®å¤±è´¥: ' + error.message);
    }
}

async function saveCrawlerConfig(formData) {
    try {
        const config = {
            max_notes: parseInt(formData.get('max_notes')),
            max_comments_per_note: parseInt(formData.get('max_comments_per_note')),
            enable_comments: formData.get('enable_comments') === 'on',
            headless: formData.get('headless') === 'on',
            save_data_option: formData.get('save_data_option'),
            default_login_type: formData.get('default_login_type')
        };
        
        const response = await apiRequest('/config/crawler', {
            method: 'PUT',
            body: JSON.stringify(config)
        });
        
        showSuccess('çˆ¬è™«é…ç½®ä¿å­˜æˆåŠŸ');
        if (response.need_restart) showRestartWarning();
        
    } catch (error) {
        showError('ä¿å­˜çˆ¬è™«é…ç½®å¤±è´¥: ' + error.message);
    }
}

async function saveSidecarConfig(formData) {
    try {
        const config = {
            url: formData.get('sidecar_url'),
            browser_pool_size: parseInt(formData.get('browser_pool_size')),
            timeout: parseInt(formData.get('sidecar_timeout')),
            session_timeout: parseInt(formData.get('session_timeout'))
        };
        
        const response = await apiRequest('/config/sidecar', {
            method: 'PUT', 
            body: JSON.stringify(config)
        });
        
        showSuccess('è¾¹è½¦é…ç½®ä¿å­˜æˆåŠŸ');
        if (response.need_restart) showRestartWarning();
        
    } catch (error) {
        showError('ä¿å­˜è¾¹è½¦é…ç½®å¤±è´¥: ' + error.message);
    }
}

function showRestartWarning() {
    document.getElementById('restart-warning').classList.remove('d-none');
}

function hideRestartWarning() {
    document.getElementById('restart-warning').classList.add('d-none');
}

// è¡¨å•äº‹ä»¶ç»‘å®š
document.addEventListener('DOMContentLoaded', function() {
    loadPlatformConfig();
    loadCurrentConfig();
    
    // å¹³å°é…ç½®è¡¨å•
    document.getElementById('platform-config-form').addEventListener('submit', function(e) {
        e.preventDefault();
        savePlatformConfig(new FormData(this));
    });
    
    // çˆ¬è™«é…ç½®è¡¨å•
    document.getElementById('crawler-config-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveCrawlerConfig(new FormData(this));
    });
    
    // è¾¹è½¦é…ç½®è¡¨å•
    document.getElementById('sidecar-config-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveSidecarConfig(new FormData(this));
    });
});
</script>
{% endblock %}
{% extends "layout.html" %}

{% block title %}é…ç½®ç®¡ç† - MCP Tools{% endblock %}

{% block content %}
<div class="space-y-6" x-data="configManager()">
    <!-- å¹³å°é…ç½® -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold mb-4">âš™ï¸ å¹³å°é…ç½®</h2>
        <div class="space-y-4" x-cloak>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">å¯ç”¨çš„å¹³å°</label>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <template x-for="platform in allPlatforms" :key="platform">
                        <label class="flex items-center space-x-2 p-2 border rounded hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox"
                                   :value="platform"
                                   x-model="enabledPlatforms"
                                   class="rounded">
                            <span class="text-sm" x-text="platformNames[platform]"></span>
                        </label>
                    </template>
                </div>
            </div>
            <button @click="savePlatformConfig"
                    class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-6 rounded">
                ä¿å­˜å¹³å°é…ç½®
            </button>
        </div>
    </div>

    <!-- çˆ¬è™«é…ç½® -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-bold mb-4">ğŸ•·ï¸ çˆ¬è™«é…ç½®</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" x-cloak>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">æœ€å¤§çˆ¬å–æ•°é‡</label>
                <input type="number" x-model.number="crawlerConfig.max_notes"
                       class="w-full border rounded p-2" min="1" max="1000">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">æ¯å¸–æœ€å¤§è¯„è®ºæ•°</label>
                <input type="number" x-model.number="crawlerConfig.max_comments_per_note"
                       class="w-full border rounded p-2" min="0" max="100">
            </div>
            <div>
                <label class="flex items-center space-x-2 p-2 border rounded">
                    <input type="checkbox" x-model="crawlerConfig.enable_comments" class="rounded">
                    <span>å¯ç”¨è¯„è®ºçˆ¬å–</span>
                </label>
            </div>
            <div>
                <label class="flex items-center space-x-2 p-2 border rounded">
                    <input type="checkbox" x-model="crawlerConfig.headless" class="rounded">
                    <span>æ— å¤´æ¨¡å¼ï¼ˆæ— æµè§ˆå™¨ç•Œé¢ï¼‰</span>
                </label>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">æ•°æ®ä¿å­˜æ–¹å¼</label>
                <select x-model="crawlerConfig.save_data_option" class="w-full border rounded p-2">
                    <option value="json">JSONæ–‡ä»¶</option>
                    <option value="csv">CSVæ–‡ä»¶</option>
                    <option value="sqlite">SQLiteæ•°æ®åº“</option>
                    <option value="db">MySQL/PostgreSQLæ•°æ®åº“</option>
                </select>
            </div>
        </div>
        <button @click="saveCrawlerConfig"
                class="mt-4 bg-green-500 hover:bg-green-600 text-white py-2 px-6 rounded">
            ä¿å­˜çˆ¬è™«é…ç½®
        </button>
    </div>

    <!-- è­¦å‘Šæç¤º -->
    <div x-show="needRestart" x-cloak
         class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
        <div class="flex">
            <div class="flex-shrink-0">âš ï¸</div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700">
                    é…ç½®å·²æ›´æ–°ï¼Œéœ€è¦é‡å¯æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function configManager() {
    return {
        allPlatforms: [],
        platformNames: {},
        enabledPlatforms: [],
        crawlerConfig: {},
        needRestart: false,

        async init() {
            await this.loadPlatformConfig();
            await this.loadCrawlerConfig();
        },

        async loadPlatformConfig() {
            try {
                const response = await fetch('/api/config/platforms');
                const data = await response.json();
                this.allPlatforms = data.all_platforms;
                this.platformNames = data.platform_names;
                this.enabledPlatforms = data.enabled_platforms;
            } catch (error) {
                console.error('åŠ è½½å¹³å°é…ç½®å¤±è´¥:', error);
            }
        },

        async loadCrawlerConfig() {
            try {
                const response = await fetch('/api/config/crawler');
                this.crawlerConfig = await response.json();
            } catch (error) {
                console.error('åŠ è½½çˆ¬è™«é…ç½®å¤±è´¥:', error);
            }
        },

        async savePlatformConfig() {
            try {
                const response = await fetch('/api/config/platforms', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        enabled_platforms: this.enabledPlatforms
                    })
                });
                const result = await response.json();
                this.needRestart = result.need_restart;
                alert(result.message);
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        },

        async saveCrawlerConfig() {
            try {
                const response = await fetch('/api/config/crawler', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(this.crawlerConfig)
                });
                const result = await response.json();
                this.needRestart = result.need_restart;
                alert(result.message);
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }
    }
}
</script>
{% endblock %}
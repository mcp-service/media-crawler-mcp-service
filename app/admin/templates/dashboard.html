{% extends "layout.html" %}

{% block title %}ä»ªè¡¨æ¿ - MCP Tools{% endblock %}

{% block content %}
<div id="status-display">
    <!-- ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ -->
    <div class="card">
        <div class="card-header">
            <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col">
                    <div class="text-center">
                        <div style="font-size: 2rem; color: #007bff; margin-bottom: 0.5rem;">ğŸ’»</div>
                        <div style="font-size: 0.875rem; color: #6c757d;">CPUä½¿ç”¨ç‡</div>
                        <div style="font-size: 1.5rem; font-weight: bold;" id="cpu-percent">--%</div>
                    </div>
                </div>
                <div class="col">
                    <div class="text-center">
                        <div style="font-size: 2rem; color: #28a745; margin-bottom: 0.5rem;">ğŸ§ </div>
                        <div style="font-size: 0.875rem; color: #6c757d;">å†…å­˜ä½¿ç”¨ç‡</div>
                        <div style="font-size: 1.5rem; font-weight: bold;" id="memory-percent">--%</div>
                    </div>
                </div>
                <div class="col">
                    <div class="text-center">
                        <div style="font-size: 2rem; color: #ffc107; margin-bottom: 0.5rem;">ğŸ’¾</div>
                        <div style="font-size: 0.875rem; color: #6c757d;">ç£ç›˜ä½¿ç”¨ç‡</div>
                        <div style="font-size: 1.5rem; font-weight: bold;" id="disk-percent">--%</div>
                    </div>
                </div>
                <div class="col">
                    <div class="text-center">
                        <div style="font-size: 2rem; color: #6f42c1; margin-bottom: 0.5rem;">ğŸ“ˆ</div>
                        <div style="font-size: 0.875rem; color: #6c757d;">æ•°æ®æ–‡ä»¶</div>
                        <div style="font-size: 1.5rem; font-weight: bold;" id="total-files">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æœåŠ¡çŠ¶æ€ -->
    <div class="card">
        <div class="card-header">
            <h2>ğŸ”§ æœåŠ¡çŠ¶æ€</h2>
        </div>
        <div class="card-body">
            <div class="row" id="services-status">
                <div class="col">
                    <h4>MCP æœåŠ¡</h4>
                    <p class="status" id="mcp-service-status">æ£€æŸ¥ä¸­...</p>
                    <small>ç«¯å£: 9090</small>
                </div>
                <div class="col">
                    <h4>ç®¡ç†ç•Œé¢</h4>
                    <p class="status status-success">è¿è¡Œä¸­</p>
                    <small>è·¯å¾„: /admin</small>
                </div>
                <div class="col">
                    <h4>æ•°æ®åº“</h4>
                    <p class="status" id="database-status">æ£€æŸ¥ä¸­...</p>
                    <small>PostgreSQL</small>
                </div>
                <div class="col">
                    <h4>Redisç¼“å­˜</h4>
                    <p class="status" id="redis-status">æ£€æŸ¥ä¸­...</p>
                    <small>Redis</small>
                </div>
            </div>
        </div>
    </div>

    <!-- å¹³å°çŠ¶æ€ -->
    <div class="card">
        <div class="card-header">
            <h2>ğŸ“± å¹³å°çŠ¶æ€</h2>
        </div>
        <div class="card-body">
            <div class="platform-list" id="platforms-status">
                <!-- å¹³å°çŠ¶æ€å°†ç”±JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <!-- çˆ¬å–æ•°æ®ç»Ÿè®¡ -->
    <div class="card">
        <div class="card-header">
            <h2>ğŸ“ˆ æ•°æ®ç»Ÿè®¡</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col">
                    <div><strong>æ€»æ–‡ä»¶æ•°:</strong> <span id="data-total-files">--</span></div>
                    <div><strong>æ€»æ•°æ®å¤§å°:</strong> <span id="data-total-size">--</span></div>
                    <div><strong>æ•°æ®è·¯å¾„:</strong> <span id="data-path">--</span></div>
                </div>
            </div>
            
            <div class="mt-4">
                <h4>å„å¹³å°æ•°æ®</h4>
                <div id="platform-data-stats">
                    <p class="text-center" style="color: #6c757d; padding: 2rem;">æš‚æ— çˆ¬å–æ•°æ®</p>
                </div>
            </div>
        </div>
    </div>

    <!-- å¿«æ·æ“ä½œ -->
    <div class="card">
        <div class="card-header">
            <h2>âš¡ å¿«æ·æ“ä½œ</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col text-center">
                    <a href="/admin/login" class="btn btn-primary" style="text-decoration: none; display: block; padding: 1rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ”</div>
                        <div>ç™»å½•ç®¡ç†</div>
                    </a>
                </div>
                <div class="col text-center">
                    <a href="/admin/config" class="btn btn-primary" style="text-decoration: none; display: block; padding: 1rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">âš™ï¸</div>
                        <div>é…ç½®ç®¡ç†</div>
                    </a>
                </div>
                <div class="col text-center">
                    <button class="btn btn-primary" onclick="refreshAllData()" style="display: block; width: 100%; padding: 1rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ”„</div>
                        <div>åˆ·æ–°æ•°æ®</div>
                    </button>
                </div>
                <div class="col text-center">
                    <a href="http://localhost:9090/sse" target="_blank" class="btn btn-primary" style="text-decoration: none; display: block; padding: 1rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ”Œ</div>
                        <div>MCPæœåŠ¡</div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dashboard specific functions
async function loadSystemStatus() {
    try {
        const response = await apiRequest('/status/system');
        document.getElementById('cpu-percent').textContent = response.cpu_percent + '%';
        document.getElementById('memory-percent').textContent = response.memory_percent + '%';
        document.getElementById('disk-percent').textContent = response.disk_usage_percent + '%';
    } catch (error) {
        console.error('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
    }
}

async function loadServicesStatus() {
    try {
        const response = await apiRequest('/status/services');

        // æ›´æ–°å„æœåŠ¡çŠ¶æ€
        updateServiceStatus('mcp-service-status', response.mcp_service);
        updateServiceStatus('database-status', response.database);
        updateServiceStatus('redis-status', response.redis);
    } catch (error) {
        console.error('åŠ è½½æœåŠ¡çŠ¶æ€å¤±è´¥:', error);
    }
}

function updateServiceStatus(elementId, serviceStatus) {
    const element = document.getElementById(elementId);
    if (element && serviceStatus) {
        element.textContent = serviceStatus.status === 'running' ? 'è¿è¡Œä¸­' : 'æœªçŸ¥';
        element.className = `status ${serviceStatus.status === 'running' ? 'status-success' : 'status-error'}`;
    }
}

async function loadPlatformsStatus() {
    try {
        const platforms = await apiRequest('/status/platforms');
        const container = document.getElementById('platforms-status');
        
        container.innerHTML = platforms.map(platform => `
            <div class="platform-item ${platform.enabled ? 'enabled' : 'disabled'}">
                <h4>${platform.name}</h4>
                <div style="margin-top: 0.5rem;">
                    <div style="font-size: 0.875rem;">
                        ${platform.has_session ? 'âœ…' : 'âŒ'} ç™»å½•çŠ¶æ€
                    </div>
                    <div style="font-size: 0.875rem;">
                        ${platform.tools_available ? 'âœ…' : 'âŒ'} å·¥å…·å¯ç”¨
                    </div>
                </div>
                <div class="status ${platform.enabled ? 'status-success' : 'status-info'}" style="margin-top: 0.5rem;">
                    ${platform.enabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('åŠ è½½å¹³å°çŠ¶æ€å¤±è´¥:', error);
    }
}

async function loadDataStatus() {
    try {
        const response = await apiRequest('/status/data');
        
        document.getElementById('data-total-files').textContent = response.total_files || 0;
        document.getElementById('data-total-size').textContent = (response.total_size_mb || 0) + ' MB';
        document.getElementById('data-path').textContent = response.data_path || '--';
        document.getElementById('total-files').textContent = response.total_files || 0;
        
        // æ›´æ–°å¹³å°æ•°æ®ç»Ÿè®¡
        const platformDataContainer = document.getElementById('platform-data-stats');
        if (response.platforms && Object.keys(response.platforms).length > 0) {
            platformDataContainer.innerHTML = Object.entries(response.platforms).map(([platform, stats]) => `
                <div class="card" style="margin-bottom: 1rem;">
                    <div class="card-body">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>${platform}</strong>
                            <span style="color: #6c757d;">${stats.files_count} ä¸ªæ–‡ä»¶</span>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6c757d;">
                            å¤§å°: ${stats.total_size_mb} MB | æœ€æ–°: ${stats.latest_file}
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            platformDataContainer.innerHTML = '<p class="text-center" style="color: #6c757d; padding: 2rem;">æš‚æ— çˆ¬å–æ•°æ®</p>';
        }
    } catch (error) {
        console.error('åŠ è½½æ•°æ®çŠ¶æ€å¤±è´¥:', error);
    }
}

async function refreshAllData() {
    showMessage('æ­£åœ¨åˆ·æ–°æ•°æ®...', 'info');
    
    await Promise.all([
        loadSystemStatus(),
        loadServicesStatus(), 
        loadPlatformsStatus(),
        loadDataStatus()
    ]);
    
    showSuccess('æ•°æ®å·²åˆ·æ–°');
}

// é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½æ•°æ®
document.addEventListener('DOMContentLoaded', function() {
    refreshAllData();
    
    // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
    setInterval(refreshAllData, 30000);
});
</script>
{% endblock %}
{% extends "layout.html" %}

{% block title %}çŠ¶æ€ç›‘æ§ - Media Crawler{% endblock %}

{% block content %}
<section class="dashboard-page">
    <header class="dashboard-hero">
        <div>
            <span class="hero-pill">è¿è¡Œæ¦‚å†µ</span>
            <h2 class="hero-title page-title">
                å®æ—¶çŠ¶æ€ç›‘æ§ä¸­å¿ƒ
                <span id="page-status" class="page-status"></span>
            </h2>
            <p class="hero-subtitle">
                èšåˆåå°æœåŠ¡ã€æµè§ˆå™¨ä¼šè¯ä¸æ•°æ®è½ç›˜çŠ¶å†µï¼Œ30 ç§’è‡ªåŠ¨åˆ·æ–°ï¼Œæä¾›ä¸€ç›®äº†ç„¶çš„å¯è§‚æµ‹æ€§é¢æ¿ã€‚
            </p>
        </div>
        <div class="hero-actions">
            <a href="/admin/login" class="btn btn-primary">å‰å¾€ç™»å½•ä¸­å¿ƒ</a>
            <button class="btn btn-secondary" type="button" onclick="refreshAllData()">ç«‹å³åˆ·æ–°</button>
        </div>
    </header>

    <div id="status-display" class="dashboard-status-strip">
        <div class="status-placeholder">æ­£åœ¨è·å–æœåŠ¡çŠ¶æ€...</div>
    </div>

    <section class="metric-grid">
        <article class="metric-card">
            <span class="metric-icon">ğŸ’»</span>
            <span class="metric-label">CPU ä½¿ç”¨ç‡</span>
            <span class="metric-value" id="cpu-percent">--%</span>
        </article>
        <article class="metric-card">
            <span class="metric-icon">ğŸ§ </span>
            <span class="metric-label">å†…å­˜ä½¿ç”¨ç‡</span>
            <span class="metric-value" id="memory-percent">--%</span>
        </article>
        <article class="metric-card">
            <span class="metric-icon">ğŸ’¾</span>
            <span class="metric-label">ç£ç›˜ä½¿ç”¨ç‡</span>
            <span class="metric-value" id="disk-percent">--%</span>
        </article>
        <article class="metric-card">
            <span class="metric-icon">ğŸ“‚</span>
            <span class="metric-label">ç´¯è®¡æ•°æ®æ–‡ä»¶</span>
            <span class="metric-value" id="total-files">--</span>
        </article>
    </section>

    <section class="dashboard-grid">
        <article class="card dashboard-card">
            <div class="card-header">
                <div class="card-eyebrow">æœåŠ¡å¥åº·</div>
                <h2>æ ¸å¿ƒæœåŠ¡çŠ¶æ€</h2>
            </div>
            <div class="card-body">
                <div class="service-grid" id="services-status">
                    <div class="service-item">
                        <span class="service-title">MCP æœåŠ¡</span>
                        <span class="status" id="mcp-service-status">æ£€æŸ¥ä¸­...</span>
                        <span class="service-meta">ç«¯å£ 9090</span>
                    </div>
                    <div class="service-item">
                        <span class="service-title">ç®¡ç†ç•Œé¢</span>
                        <span class="status status-success">è¿è¡Œä¸­</span>
                        <span class="service-meta">è·¯å¾„ /admin</span>
                    </div>
                    <div class="service-item">
                        <span class="service-title">æ•°æ®åº“</span>
                        <span class="status" id="database-status">æ£€æŸ¥ä¸­...</span>
                        <span class="service-meta">PostgreSQL</span>
                    </div>
                    <div class="service-item">
                        <span class="service-title">Redis ç¼“å­˜</span>
                        <span class="status" id="redis-status">æ£€æŸ¥ä¸­...</span>
                        <span class="service-meta">Redis</span>
                    </div>
                </div>
            </div>
        </article>

        <article class="card dashboard-card">
            <div class="card-header">
                <div class="card-eyebrow">ç™»å½•æ€æ€»è§ˆ</div>
                <h2>å¹³å°ä¼šè¯é¢æ¿</h2>
            </div>
            <div class="card-body">
                <div class="platform-groups" id="platforms-status">
                    <div class="platform-empty">æ­£åœ¨åŠ è½½å¹³å°çŠ¶æ€...</div>
                </div>
            </div>
        </article>

        <article class="card dashboard-card">
            <div class="card-header">
                <div class="card-eyebrow">è½ç›˜ç›‘æ§</div>
                <h2>æ•°æ®æŒä¹…åŒ–æ¦‚è§ˆ</h2>
            </div>
            <div class="card-body">
                <div class="data-overview">
                    <div class="data-overview__item">
                        <span class="data-overview__label">æ–‡ä»¶æ€»æ•°</span>
                        <span class="data-overview__value" id="data-total-files">--</span>
                    </div>
                    <div class="data-overview__item">
                        <span class="data-overview__label">æ•°æ®å®¹é‡</span>
                        <span class="data-overview__value" id="data-total-size">-- MB</span>
                    </div>
                    <div class="data-overview__item data-overview__item--full">
                        <span class="data-overview__label">æ•°æ®ç›®å½•</span>
                        <span class="data-overview__value" id="data-path">--</span>
                    </div>
                </div>
                <div class="platform-data-grid" id="platform-data-stats">
                    <div class="status-placeholder">æš‚æ— çˆ¬å–æ•°æ®</div>
                </div>
            </div>
        </article>

        <article class="card dashboard-card">
            <div class="card-header">
                <div class="card-eyebrow">å¿«æ·å…¥å£</div>
                <h2>é«˜é¢‘æ“ä½œ</h2>
            </div>
            <div class="card-body">
                <div class="quick-action-grid">
                    <a href="/admin/login" class="quick-action-card">
                        <span class="quick-action-icon">ğŸ”</span>
                        <span class="quick-action-title">ç™»å½•ç®¡ç†</span>
                        <span class="quick-action-desc">æŸ¥çœ‹æ‰«ç ã€Cookieã€æ‰‹æœºå·ç™»å½•æ€</span>
                    </a>
                    <a href="/admin/config" class="quick-action-card">
                        <span class="quick-action-icon">âš™ï¸</span>
                        <span class="quick-action-title">é…ç½®ç®¡ç†</span>
                        <span class="quick-action-desc">ç»´æŠ¤å¹³å°å¼€å…³ä¸çˆ¬è™«å‚æ•°</span>
                    </a>
                    <button type="button" class="quick-action-card" onclick="refreshAllData()">
                        <span class="quick-action-icon">ğŸ”„</span>
                        <span class="quick-action-title">åˆ·æ–°é¢æ¿</span>
                        <span class="quick-action-desc">åŒæ­¥æœ€æ–°çš„æœåŠ¡ä¸æ•°æ®çŠ¶æ€</span>
                    </button>
                    <a href="http://localhost:9090/sse" target="_blank" rel="noopener" class="quick-action-card">
                        <span class="quick-action-icon">ğŸ”Œ</span>
                        <span class="quick-action-title">SSE ç»ˆç«¯</span>
                        <span class="quick-action-desc">æ‰“å¼€ MCP SSE æµå¼è¾“å‡º</span>
                    </a>
                </div>
            </div>
        </article>
    </section>
</section>
{% endblock %}

{% block scripts %}
<script>
// Dashboard specific functions
async function loadSystemStatus() {
    try {
        const response = await apiRequest('/status/system');
        document.getElementById('cpu-percent').textContent = `${response.cpu_percent || 0}%`;
        document.getElementById('memory-percent').textContent = `${response.memory_percent || 0}%`;
        document.getElementById('disk-percent').textContent = `${response.disk_usage_percent || 0}%`;
    } catch (error) {
        console.error('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
    }
}

async function loadServicesStatus() {
    try {
        const response = await apiRequest('/status/services');

        updateServiceStatus('mcp-service-status', response.mcp_service);
        updateServiceStatus('database-status', response.database);
        updateServiceStatus('redis-status', response.redis);
    } catch (error) {
        console.error('åŠ è½½æœåŠ¡çŠ¶æ€å¤±è´¥:', error);
    }
}

function updateServiceStatus(elementId, serviceStatus) {
    const element = document.getElementById(elementId);
    if (element && serviceStatus) {
        element.textContent = serviceStatus.status === 'running' ? 'è¿è¡Œä¸­' : 'æœªçŸ¥';
        element.className = `status ${serviceStatus.status === 'running' ? 'status-success' : 'status-error'}`;
    }
}

async function loadPlatformsStatus() {
    try {
        const platforms = await apiRequest('/status/platforms');
        const container = document.getElementById('platforms-status');

        if (!platforms.length) {
            container.innerHTML = '<div class="platform-empty">æš‚æ— å¹³å°çŠ¶æ€ä¿¡æ¯</div>';
            return;
        }

        const groups = [
            { title: 'å·²ç™»å½•', filter: (p) => p.has_session, statusLabel: 'åœ¨çº¿' },
            { title: 'æœªç™»å½•', filter: (p) => !p.has_session, statusLabel: 'ç¦»çº¿' }
        ];

        container.innerHTML = groups.map((group) => {
            const groupItems = platforms.filter(group.filter);
            const groupContent = groupItems.length
                ? groupItems.map((platform) => {
                    const metaParts = [];
                    metaParts.push(platform.enabled ? 'å·²å¯ç”¨' : 'åœç”¨');
                    metaParts.push(platform.tools_available ? 'å·¥å…·å¯ç”¨' : 'å·¥å…·å—é™');
                    if (platform.last_activity) {
                        metaParts.push(platform.last_activity);
                    }
                    return `
                        <div class="platform-chip ${platform.has_session ? 'is-active' : ''}">
                            <div class="platform-chip__details">
                                <span class="platform-chip__name">${platform.name}</span>
                                <span class="platform-chip__meta">${metaParts.join(' Â· ')}</span>
                            </div>
                            <span class="platform-chip__status">${group.statusLabel}</span>
                        </div>
                    `;
                }).join('')
                : '<div class="platform-group__empty">æš‚æ— å¹³å°</div>';

            return `
                <section class="platform-group">
                    <header class="platform-group__header">
                        <span class="platform-group__title">${group.title}</span>
                        <span class="platform-group__count">${groupItems.length}</span>
                    </header>
                    <div class="platform-group__list">
                        ${groupContent}
                    </div>
                </section>
            `;
        }).join('');
    } catch (error) {
        console.error('åŠ è½½å¹³å°çŠ¶æ€å¤±è´¥:', error);
    }
}

async function loadDataStatus() {
    try {
        const response = await apiRequest('/status/data');

        document.getElementById('data-total-files').textContent = response.total_files || 0;
        document.getElementById('data-total-size').textContent = `${response.total_size_mb || 0} MB`;
        document.getElementById('data-path').textContent = response.data_path || '--';
        document.getElementById('total-files').textContent = response.total_files || 0;

        const platformDataContainer = document.getElementById('platform-data-stats');
        if (response.platforms && Object.keys(response.platforms).length > 0) {
            platformDataContainer.innerHTML = Object.entries(response.platforms).map(([platform, stats]) => `
                <div class="data-card">
                    <div class="data-card__header">
                        <span class="data-card__title">${platform}</span>
                        <span class="data-card__files">${stats.files_count} ä¸ªæ–‡ä»¶</span>
                    </div>
                    <div class="data-card__meta">
                        <span>å®¹é‡ ${stats.total_size_mb} MB</span>
                        <span>æœ€æ–° ${stats.latest_file || 'æœªçŸ¥'}</span>
                    </div>
                </div>
            `).join('');
        } else {
            platformDataContainer.innerHTML = '<div class="status-placeholder">æš‚æ— çˆ¬å–æ•°æ®</div>';
        }
    } catch (error) {
        console.error('åŠ è½½æ•°æ®çŠ¶æ€å¤±è´¥:', error);
    }
}

async function refreshAllData() {
    showMessage('æ­£åœ¨åˆ·æ–°æ•°æ®...', 'info');

    await Promise.all([
        loadSystemStatus(),
        loadServicesStatus(),
        loadPlatformsStatus(),
        loadDataStatus()
    ]);

    showSuccess('æ•°æ®å·²åˆ·æ–°');
}

document.addEventListener('DOMContentLoaded', () => {
    refreshAllData();

    setInterval(refreshAllData, 30000);
});
</script>
{% endblock %}

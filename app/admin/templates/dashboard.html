{% extends "layout.html" %}

{% block title %}仪表板 - MCP Tools{% endblock %}

{% block content %}
<div id="status-display">
    <!-- 系统状态概览 -->
    <div class="card">
        <div class="card-header">
            <h2>📊 系统状态概览</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col">
                    <div class="text-center">
                        <div style="font-size: 2rem; color: #007bff; margin-bottom: 0.5rem;">💻</div>
                        <div style="font-size: 0.875rem; color: #6c757d;">CPU使用率</div>
                        <div style="font-size: 1.5rem; font-weight: bold;" id="cpu-percent">--%</div>
                    </div>
                </div>
                <div class="col">
                    <div class="text-center">
                        <div style="font-size: 2rem; color: #28a745; margin-bottom: 0.5rem;">🧠</div>
                        <div style="font-size: 0.875rem; color: #6c757d;">内存使用率</div>
                        <div style="font-size: 1.5rem; font-weight: bold;" id="memory-percent">--%</div>
                    </div>
                </div>
                <div class="col">
                    <div class="text-center">
                        <div style="font-size: 2rem; color: #ffc107; margin-bottom: 0.5rem;">💾</div>
                        <div style="font-size: 0.875rem; color: #6c757d;">磁盘使用率</div>
                        <div style="font-size: 1.5rem; font-weight: bold;" id="disk-percent">--%</div>
                    </div>
                </div>
                <div class="col">
                    <div class="text-center">
                        <div style="font-size: 2rem; color: #6f42c1; margin-bottom: 0.5rem;">📈</div>
                        <div style="font-size: 0.875rem; color: #6c757d;">数据文件</div>
                        <div style="font-size: 1.5rem; font-weight: bold;" id="total-files">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 服务状态 -->
    <div class="card">
        <div class="card-header">
            <h2>🔧 服务状态</h2>
        </div>
        <div class="card-body">
            <div class="row" id="services-status">
                <div class="col">
                    <h4>MCP 服务</h4>
                    <p class="status" id="mcp-service-status">检查中...</p>
                    <small>端口: 9090</small>
                </div>
                <div class="col">
                    <h4>管理界面</h4>
                    <p class="status status-success">运行中</p>
                    <small>路径: /admin</small>
                </div>
                <div class="col">
                    <h4>数据库</h4>
                    <p class="status" id="database-status">检查中...</p>
                    <small>PostgreSQL</small>
                </div>
                <div class="col">
                    <h4>Redis缓存</h4>
                    <p class="status" id="redis-status">检查中...</p>
                    <small>Redis</small>
                </div>
            </div>
        </div>
    </div>

    <!-- 平台状态 -->
    <div class="card">
        <div class="card-header">
            <h2>📱 平台状态</h2>
        </div>
        <div class="card-body">
            <div class="platform-list" id="platforms-status">
                <!-- 平台状态将由JavaScript动态加载 -->
            </div>
        </div>
    </div>

    <!-- 爬取数据统计 -->
    <div class="card">
        <div class="card-header">
            <h2>📈 数据统计</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col">
                    <div><strong>总文件数:</strong> <span id="data-total-files">--</span></div>
                    <div><strong>总数据大小:</strong> <span id="data-total-size">--</span></div>
                    <div><strong>数据路径:</strong> <span id="data-path">--</span></div>
                </div>
            </div>
            
            <div class="mt-4">
                <h4>各平台数据</h4>
                <div id="platform-data-stats">
                    <p class="text-center" style="color: #6c757d; padding: 2rem;">暂无爬取数据</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 快捷操作 -->
    <div class="card">
        <div class="card-header">
            <h2>⚡ 快捷操作</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col text-center">
                    <a href="/admin/login" class="btn btn-primary" style="text-decoration: none; display: block; padding: 1rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">🔐</div>
                        <div>登录管理</div>
                    </a>
                </div>
                <div class="col text-center">
                    <a href="/admin/config" class="btn btn-primary" style="text-decoration: none; display: block; padding: 1rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">⚙️</div>
                        <div>配置管理</div>
                    </a>
                </div>
                <div class="col text-center">
                    <button class="btn btn-primary" onclick="refreshAllData()" style="display: block; width: 100%; padding: 1rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">🔄</div>
                        <div>刷新数据</div>
                    </button>
                </div>
                <div class="col text-center">
                    <a href="http://localhost:9090/sse" target="_blank" class="btn btn-primary" style="text-decoration: none; display: block; padding: 1rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">🔌</div>
                        <div>MCP服务</div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dashboard specific functions
async function loadSystemStatus() {
    try {
        const response = await apiRequest('/status/system');
        document.getElementById('cpu-percent').textContent = response.cpu_percent + '%';
        document.getElementById('memory-percent').textContent = response.memory_percent + '%';
        document.getElementById('disk-percent').textContent = response.disk_usage_percent + '%';
    } catch (error) {
        console.error('加载系统状态失败:', error);
    }
}

async function loadServicesStatus() {
    try {
        const response = await apiRequest('/status/services');

        // 更新各服务状态
        updateServiceStatus('mcp-service-status', response.mcp_service);
        updateServiceStatus('database-status', response.database);
        updateServiceStatus('redis-status', response.redis);
    } catch (error) {
        console.error('加载服务状态失败:', error);
    }
}

function updateServiceStatus(elementId, serviceStatus) {
    const element = document.getElementById(elementId);
    if (element && serviceStatus) {
        element.textContent = serviceStatus.status === 'running' ? '运行中' : '未知';
        element.className = `status ${serviceStatus.status === 'running' ? 'status-success' : 'status-error'}`;
    }
}

async function loadPlatformsStatus() {
    try {
        const platforms = await apiRequest('/status/platforms');
        const container = document.getElementById('platforms-status');
        
        container.innerHTML = platforms.map(platform => `
            <div class="platform-item ${platform.enabled ? 'enabled' : 'disabled'}">
                <h4>${platform.name}</h4>
                <div style="margin-top: 0.5rem;">
                    <div style="font-size: 0.875rem;">
                        ${platform.has_session ? '✅' : '❌'} 登录状态
                    </div>
                    <div style="font-size: 0.875rem;">
                        ${platform.tools_available ? '✅' : '❌'} 工具可用
                    </div>
                </div>
                <div class="status ${platform.enabled ? 'status-success' : 'status-info'}" style="margin-top: 0.5rem;">
                    ${platform.enabled ? '已启用' : '未启用'}
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('加载平台状态失败:', error);
    }
}

async function loadDataStatus() {
    try {
        const response = await apiRequest('/status/data');
        
        document.getElementById('data-total-files').textContent = response.total_files || 0;
        document.getElementById('data-total-size').textContent = (response.total_size_mb || 0) + ' MB';
        document.getElementById('data-path').textContent = response.data_path || '--';
        document.getElementById('total-files').textContent = response.total_files || 0;
        
        // 更新平台数据统计
        const platformDataContainer = document.getElementById('platform-data-stats');
        if (response.platforms && Object.keys(response.platforms).length > 0) {
            platformDataContainer.innerHTML = Object.entries(response.platforms).map(([platform, stats]) => `
                <div class="card" style="margin-bottom: 1rem;">
                    <div class="card-body">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>${platform}</strong>
                            <span style="color: #6c757d;">${stats.files_count} 个文件</span>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6c757d;">
                            大小: ${stats.total_size_mb} MB | 最新: ${stats.latest_file}
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            platformDataContainer.innerHTML = '<p class="text-center" style="color: #6c757d; padding: 2rem;">暂无爬取数据</p>';
        }
    } catch (error) {
        console.error('加载数据状态失败:', error);
    }
}

async function refreshAllData() {
    showMessage('正在刷新数据...', 'info');
    
    await Promise.all([
        loadSystemStatus(),
        loadServicesStatus(), 
        loadPlatformsStatus(),
        loadDataStatus()
    ]);
    
    showSuccess('数据已刷新');
}

// 页面加载完成后自动加载数据
document.addEventListener('DOMContentLoaded', function() {
    refreshAllData();
    
    // 每30秒自动刷新一次
    setInterval(refreshAllData, 30000);
});
</script>
{% endblock %}
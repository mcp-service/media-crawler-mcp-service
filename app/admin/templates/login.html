{% extends "layout.html" %}

{% block title %}ç™»å½•ç®¡ç† - MCP Tools{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>ğŸ” å¹³å°ç™»å½•ç®¡ç†</h2>
    </div>
    <div class="card-body">
        <!-- ç™»å½•è¡¨å• -->
        <form id="login-form" class="mb-4">
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="platform" class="form-label">é€‰æ‹©å¹³å°</label>
                        <select name="platform" id="platform" class="form-control" required>
                            <option value="">è¯·é€‰æ‹©å¹³å°</option>
                            <option value="xhs">å°çº¢ä¹¦</option>
                            <option value="dy">æŠ–éŸ³</option>
                            <option value="ks">å¿«æ‰‹</option>
                            <option value="bili">å“”å“©å“”å“©</option>
                            <option value="wb">å¾®åš</option>
                            <option value="tieba">è´´å§</option>
                            <option value="zhihu">çŸ¥ä¹</option>
                        </select>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="login_type" class="form-label">ç™»å½•æ–¹å¼</label>
                        <select name="login_type" id="login_type" class="form-control" onchange="toggleLoginFields()">
                            <option value="qrcode">äºŒç»´ç æ‰«ç </option>
                            <option value="cookie">Cookieç™»å½•</option>
                            <option value="phone">æ‰‹æœºå·ç™»å½•</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="phone-field" class="form-group d-none">
                <label for="phone" class="form-label">æ‰‹æœºå·</label>
                <input type="tel" name="phone" id="phone" class="form-control" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
            </div>

            <div id="cookie-field" class="form-group d-none">
                <label for="cookie" class="form-label">Cookie</label>
                <textarea name="cookie" id="cookie" class="form-control" rows="4" placeholder="ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·è·å–Cookieï¼Œç²˜è´´åˆ°æ­¤å¤„..."></textarea>
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-primary">å¼€å§‹ç™»å½•</button>
                <button type="button" class="btn btn-secondary" onclick="refreshLoginStatus()">åˆ·æ–°çŠ¶æ€</button>
            </div>
        </form>

        <!-- ç™»å½•çŠ¶æ€æ˜¾ç¤º -->
        <div id="login-status" class="mb-3 text-center"></div>

        <!-- äºŒç»´ç å®¹å™¨ -->
        <div id="qr-code-container" class="d-none"></div>
    </div>
</div>

<!-- å¹³å°ç™»å½•çŠ¶æ€ -->
<div class="card">
    <div class="card-header">
        <h2>ğŸ“± å¹³å°ç™»å½•çŠ¶æ€</h2>
    </div>
    <div class="card-body">
        <div class="platform-list" id="platform-sessions">
            <div class="text-center">
                <p>æ­£åœ¨åŠ è½½å¹³å°çŠ¶æ€...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleLoginFields() {
    const loginType = document.getElementById('login_type').value;
    const phoneField = document.getElementById('phone-field');
    const cookieField = document.getElementById('cookie-field');
    
    // éšè—æ‰€æœ‰å­—æ®µ
    phoneField.classList.add('d-none');
    cookieField.classList.add('d-none');
    
    // æ ¹æ®é€‰æ‹©æ˜¾ç¤ºå¯¹åº”å­—æ®µ
    if (loginType === 'phone') {
        phoneField.classList.remove('d-none');
    } else if (loginType === 'cookie') {
        cookieField.classList.remove('d-none');
    }
}

async function refreshLoginStatus() {
    try {
        showMessage('æ­£åœ¨åˆ·æ–°ç™»å½•çŠ¶æ€...', 'info');
        
        const response = await apiRequest('/login/sessions');
        const sessions = response || [];
        
        const container = document.getElementById('platform-sessions');
        if (sessions.length === 0) {
            container.innerHTML = '<div class="text-center"><p style="color: #6c757d;">æš‚æ— ç™»å½•ä¼šè¯</p></div>';
        } else {
            container.innerHTML = sessions.map(session => `
                <div class="platform-item ${session.is_logged_in ? 'enabled' : 'disabled'}">
                    <h4>${session.platform_name || session.platform}</h4>
                    <div class="status ${session.is_logged_in ? 'status-success' : 'status-info'}" style="margin-top: 0.5rem;">
                        ${session.is_logged_in ? 'å·²ç™»å½•' : 'æœªç™»å½•'}
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6c757d;">
                        ${session.last_login || 'ä»æœªç™»å½•'}
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="quickLogin('${session.platform}')" style="margin-top: 0.5rem; width: 100%;">
                        ${session.is_logged_in ? 'é‡æ–°ç™»å½•' : 'å¼€å§‹ç™»å½•'}
                    </button>
                </div>
            `).join('');
        }
        
        showSuccess('ç™»å½•çŠ¶æ€å·²åˆ·æ–°');
    } catch (error) {
        showError('åˆ·æ–°å¤±è´¥: ' + error.message);
    }
}

function quickLogin(platform) {
    document.getElementById('platform').value = platform;
    document.getElementById('login_type').value = 'qrcode';
    toggleLoginFields();
    
    // æ»šåŠ¨åˆ°è¡¨å•
    document.getElementById('login-form').scrollIntoView({ behavior: 'smooth' });
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    refreshLoginStatus();
    
    // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ç™»å½•çŠ¶æ€
    setInterval(refreshLoginStatus, 30000);
});
</script>
{% endblock %}